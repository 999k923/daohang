<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é™æ€å¯¼èˆªç«™</title>

<style>
:root{
  --bg:#f6f7fb;
  --panel:#fff;
  --text:#101828;
  --muted:#667085;
  --line:rgba(16,24,40,.12);
  --primary:#2563eb;
  --danger:#ef4444;
  --ok:#10b981;
  --radius:16px;
  --shadow:0 10px 30px rgba(16,24,40,.12);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

a{color:inherit;text-decoration:none}

.toolbar{display:flex;gap:10px;flex-wrap:wrap}
.btn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:999px;
  padding:8px 12px;
  cursor:pointer;
  font-size:13px;
}
.btn.primary{background:#eef2ff;border-color:#c7d2fe}
.btn.ok{background:#ecfdf5;border-color:#a7f3d0}
.btn.danger{background:#fef2f2;border-color:#fecaca}
.btn:disabled{opacity:.5;cursor:not-allowed}

.adminOnly{display:none}
body.isAdmin .adminOnly{display:inline-flex}

/* ===== Layout ===== */
.wrap{max-width:1200px;margin:0 auto;padding:20px;height:100vh}
.grid{
  display:grid;
  grid-template-columns:260px 1fr;
  gap:16px;
  height:100%;
}
.sidebarCollapsed .grid{grid-template-columns:56px 1fr}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

.sidebar,.panel{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

/* ===== Sidebar ===== */
.sidebar{padding:12px;height:100%;overflow:auto}
.sidebarHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  gap:8px;
  position:sticky;
  top:0;
  background:var(--panel);
  padding:8px 0 10px;
  z-index:5;
  border-bottom:1px solid rgba(16,24,40,.06);
}
.sidebarHeaderTitle{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}

.sidebarBrandIcon{
  width:28px;
  height:28px;
  border-radius:10px;
  border:1px solid var(--line);
  background:linear-gradient(180deg,#ffffff,#f3f4f6);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  flex:0 0 auto;
}
.sidebarBrandIcon svg{width:18px;height:18px;display:block}
.sidebarBrandText{
  display:flex;
  flex-direction:column;
  min-width:0;
}
.sidebarBrandTitle{
  font-weight:800;
  font-size:13px;
  line-height:1.1;
  color:var(--text);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.sidebarBrandSub{
  font-size:12px;
  color:var(--muted);
  line-height:1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  display:none; /* ä¸éœ€è¦å‰¯æ ‡é¢˜æ–‡æ¡ˆ */
}
.sidebarHeaderActions{
  display:flex;
  align-items:center;
  gap:8px;
  flex:0 0 auto;
}

/* ç´§å‡‘å‹å›¾æ ‡æŒ‰é’®ï¼ˆä¾§è¾¹æ æ ‡é¢˜æ ä¸“ç”¨ï¼‰ */
.iconBtn{
  border:1px solid var(--line);
  background:#fff;
  border-radius:10px;
  width:32px;
  height:32px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.iconBtn:hover{background:#f9fafb}
.iconBtn:active{transform:translateY(1px)}
.iconBtn svg{width:16px;height:16px;display:block}

/* æŠ˜å æ—¶ï¼šéšè—æ ‡é¢˜æ–‡æœ¬ä¸ç®¡ç†å‘˜æ“ä½œæŒ‰é’®ï¼ˆä¿ç•™æŠ˜å æŒ‰é’®ï¼‰ */
.sidebarCollapsed .sidebarBrandText{display:none}
.sidebarCollapsed .sidebarHeaderActions .adminOnly{display:none !important}

.sidebarToggleBtn{
  border:none;
  background:#fff;
  border:1px solid var(--line);
  border-radius:10px;
  width:32px;
  height:32px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.sidebarToggleBtn:hover{background:#f9fafb}
.sidebarCollapsed #catList{display:none}
.sidebarCollapsed .sidebarTools{display:none}
.sidebarTools{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin:8px 0 12px;
}
.sidebarTools .btn,
.sidebarTools input{width:100%}
.sidebarTools input{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--line);
}
.catItem{
  padding:10px;
  border-radius:12px;
  margin-bottom:6px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.catItem.active{background:#eef2ff}
.catGroup{margin-bottom:8px}
.catToggle{
  border:none;
  background:transparent;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:28px;
  height:28px;
  border-radius:8px;
}
.catToggle:hover{background:#f2f4f7}
.catToggleIcon{
  display:inline-block;
  transition:transform .2s ease;
  font-size:12px;
  color:var(--muted);
}
.catIcon{
  width:22px;
  height:22px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  background:#f8fafc;
  border:1px solid var(--line);
  font-size:14px;
  flex:0 0 22px;
  overflow:hidden;
}
.catIcon img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.catGroup.expanded .catToggleIcon{transform:rotate(90deg)}
.subList{
  margin-left:12px;
  padding-left:10px;
  border-left:1px dashed var(--line);
  display:none;
  flex-direction:column;
  gap:4px;
  margin-bottom:8px;
}
.catGroup.expanded .subList{display:flex}
.subItem{
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:13px;
  color:var(--text);
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.subItem:hover{background:#f8fafc}
.subItem.active{background:#eff6ff;color:#1d4ed8}

/* ===== Panel ===== */
.panel{padding:14px;height:100%;overflow:auto}
.subcats{display:flex;flex-direction:column;gap:16px}

.subcat{
  border:1px solid var(--line);
  border-radius:16px;
  background:#f9fafb;
}
.subHead{
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--line);
}

/* ===== Cards ===== */
.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  padding:12px;
}
@media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.cards{grid-template-columns:1fr}}

.card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  min-height:150px;
}

.cardTitle{
  font-weight:700;
  font-size:14px;
  line-height:1.35;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.cardUrl{
  font-size:12px;
  color:var(--muted);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.cardDesc{
  font-size:12px;
  color:#333;
  line-height:1.4;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* ===== Tooltip ===== */
.tooltip{
  position:fixed;
  z-index:99999;
  max-width:420px;
  background:rgba(17,24,39,.96);
  color:#fff;
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 18px 45px rgba(0,0,0,.3);
  display:none;
  pointer-events:none;
}
.tooltip .ttTitle{font-weight:700;font-size:13px;margin-bottom:6px}
.tooltip .ttUrl{font-size:12px;opacity:.9;word-break:break-all;margin-bottom:6px}
.tooltip .ttDesc{font-size:12px;opacity:.85;line-height:1.45}

/* ===== Modal / Toast ===== */
.modalMask{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:8px 14px;
  border-radius:999px;
  display:none;
}

/* ===== Card fixed size & no overflow (ä¿®å¤å¡ç‰‡æ’‘å¼€/æº¢å‡º) ===== */
.cards{
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  overflow: hidden;
}
.card{
  height: 140px;         /* å›ºå®šå¡ç‰‡é«˜åº¦ */
  min-height: 140px;     /* è¦†ç›–æ—§çš„ min-height */
  overflow: hidden;      /* å†…å®¹ä¸å…è®¸æº¢å‡ºå¡ç‰‡ */
  min-width: 0;          /* é˜²æ­¢å­å…ƒç´ æ’‘ç ´ grid */
}
.cardTitle{
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.cardUrl{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cardDesc{
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* å›¾æ ‡æ°¸è¿œè£åˆ‡åœ¨æ¡†å†…ï¼ˆé˜²æ­¢å›¾ç‰‡æº¢å‡ºï¼‰ */
.card img{
  object-fit: cover;
  max-width: 34px;
  max-height: 34px;
}


/* ===== Compact cards (æ›´ç´§å‡‘ï¼Œä¸€å±æ›´å¤šç½‘ç«™) ===== */
.cards{
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 10px;
  padding: 10px;
}
.card{
  height: 104px;
  min-height: 104px;
  padding: 10px;
  border-radius: 14px;
  gap: 6px;
}
.cardTitle{
  font-size: 13px;
  -webkit-line-clamp: 1;
}
.cardUrl{
  font-size: 11px;
}
.cardDesc{
  display:none; /* ç´§å‡‘æ¨¡å¼é»˜è®¤éšè—æè¿°ï¼ˆhover æ°”æ³¡å¯çœ‹å®Œæ•´ï¼‰ */
}
.card img{
  width: 30px !important;
  height: 30px !important;
  max-width: 30px !important;
  max-height: 30px !important;
  border-radius: 10px !important;
}


/* ===== Ultra Compact cardsï¼ˆä¸€å±æœ€å¤§åŒ–ï¼‰ ===== */
.cards{
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
  padding: 8px;
}
.card{
  height: 72px;
  min-height: 72px;
  padding: 8px;
  border-radius: 12px;
  gap: 4px;
}
.cardTitle{
  font-size: 12px;
  -webkit-line-clamp: 1;
}
.cardUrl{
  font-size: 10px;
}
.cardDesc{display:none;}
.card img{
  width: 24px !important;
  height: 24px !important;
  max-width: 24px !important;
  max-height: 24px !important;
  border-radius: 8px !important;
}


/* ===== Mobile: auto switch to list view ===== */
@media (max-width: 600px){
  .cards{
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:8px;
  }
  .card{
    height:auto;
    min-height:0;
    flex-direction:row;
    align-items:center;
    padding:10px;
    gap:10px;
  }
  /* left block (icon + text) should shrink correctly */
  .card > div:first-child{
    flex:1 1 auto;
    min-width:0;
  }
  /* action buttons column stays compact */
  .card > div:last-child{
    flex:0 0 auto;
  }
  /* text a bit larger for readability on phone */
  .cardTitle{font-size:14px;-webkit-line-clamp:1}
  .cardUrl{font-size:12px}
  .card img{
    width:28px !important;
    height:28px !important;
    max-width:28px !important;
    max-height:28px !important;
    border-radius:9px !important;
  }
}

</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <aside class="sidebar">
      <div class="sidebarHeader">
  <div class="sidebarHeaderTitle" title="æˆ‘çš„å¯¼èˆª">
    <div class="sidebarBrandIcon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
  <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="rgba(37,99,235,.9)" stroke-width="1.7"/>
  <path d="M2 12h20" stroke="rgba(37,99,235,.75)" stroke-width="1.7" stroke-linecap="round"/>
  <path d="M12 2c3 3 3 17 0 20" stroke="rgba(37,99,235,.75)" stroke-width="1.7" stroke-linecap="round"/>
  <path d="M12 2c-3 3-3 17 0 20" stroke="rgba(37,99,235,.35)" stroke-width="1.7" stroke-linecap="round"/>
</svg></div>
    <div class="sidebarBrandText">
      <div class="sidebarBrandTitle">æˆ‘çš„å¯¼èˆª</div>
      <div class="sidebarBrandSub">å¯¼èˆª</div>
    </div>
  </div>

  <div class="sidebarHeaderActions">
    <button class="iconBtn adminOnly" id="btnAddTop" title="æ–°å¢ä¸€çº§" aria-label="æ–°å¢ä¸€çº§"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="rgba(16,24,40,.85)" stroke-width="2" stroke-linecap="round"/></svg></button>
    <button class="iconBtn adminOnly" id="btnAddSub" title="æ–°å¢äºŒçº§" aria-label="æ–°å¢äºŒçº§"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3 3 8l9 5 9-5-9-5Z" stroke="rgba(16,24,40,.85)" stroke-width="1.8" stroke-linejoin="round"/><path d="M3 12l9 5 9-5" stroke="rgba(16,24,40,.6)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 16l9 5 9-5" stroke="rgba(16,24,40,.35)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <button class="iconBtn adminOnly" id="btnAddSite" title="æ–°å¢ç½‘ç«™" aria-label="æ–°å¢ç½‘ç«™"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M10 13a5 5 0 0 1 0-7l1.5-1.5a5 5 0 0 1 7 7L17 12" stroke="rgba(16,24,40,.85)" stroke-width="1.8" stroke-linecap="round"/><path d="M14 11a5 5 0 0 1 0 7L12.5 19.5a5 5 0 0 1-7-7L7 12" stroke="rgba(16,24,40,.55)" stroke-width="1.8" stroke-linecap="round"/></svg></button>
    <button class="sidebarToggleBtn" id="btnToggleSidebar" aria-label="æŠ˜å /å±•å¼€ä¾§è¾¹æ ">â˜°</button>
  </div>
</div>
<div class="sidebarTools">
        <input id="searchInput" placeholder="å…¨å±€æœç´¢æ ‡é¢˜/æè¿°/URL..." />

        <span id="loginBadge" style="font-size:12px;color:var(--muted);padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff">
          â— <span id="loginText">æ¸¸å®¢æ¨¡å¼</span>
        </span>

        <button class="btn" id="btnLogin">ç™»å½•</button>
        <button class="btn" id="btnLogout" style="display:none">é€€å‡º</button>
<button class="btn adminOnly" id="btnExport">å¯¼å‡ºJSON</button>
        <button class="btn adminOnly" id="btnImport">å¯¼å…¥JSON</button>
      </div>
      <div id="catList"></div>
    </aside>

    <main class="panel">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap">
        <div>
          <h2 id="activeTitle" style="margin:0;font-size:16px">-</h2>
          <div id="activeMeta" style="font-size:12px;color:var(--muted)">-</div>
        </div>
      </div>
      <div id="content" style="margin-top:12px"></div>
    </main>
  </div>
</div>

<!-- Modal -->
<div class="modalMask" id="modalMask">
  <div style="width:min(720px,100%);background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);overflow:hidden">
    <div style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <b id="modalTitle">ç¼–è¾‘</b>
      <button class="btn" id="modalClose">å…³é—­</button>
    </div>
    <div id="modalBody" style="padding:14px;display:flex;flex-direction:column;gap:10px"></div>
    <div id="modalFoot" style="padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap"></div>
  </div>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip">
  <div class="ttTitle" id="ttTitle"></div>
  <div class="ttUrl" id="ttUrl"></div>
  <div class="ttDesc" id="ttDesc"></div>
</div>

<div class="toast" id="toast"></div>

<script>
/** ==========================
 *  API é…ç½®ï¼ˆåŒåŸŸåä»£ /apiï¼‰
 * ========================== */
const API_DATA_URL = "/api/data";
const API_LOGIN_URL = "/api/login";
const API_LOGOUT_URL = "/api/logout";
const TOKEN_KEY = "navsite_api_token_v1";
const LOCAL_CACHE_KEY = "navsite_local_cache_v1";

/** ==========================
 *  State
 * ========================== */
let state = { version: 1, updatedAt: new Date().toISOString(), categories: [] };
let activeCatId = null;
let searchText = "";
let activeSubcatId = null;
let isSidebarCollapsed = false;
const expandedCatIds = new Set();

/** ==========================
 *  Utils
 * ========================== */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function byOrder(a,b){ return (a.order ?? 0) - (b.order ?? 0); }
function nextOrder(arr){ return (arr||[]).reduce((m,x)=>Math.max(m, Number(x.order)||0),0)+1; }
function fmtTime(iso){
  try{
    const d = new Date(iso);
    const p=n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }catch{return iso}
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display="block";
  clearTimeout(toast._timer);
  toast._timer=setTimeout(()=>t.style.display="none",1700);
}

function getToken(){ return sessionStorage.getItem(TOKEN_KEY) || ""; }
function isAdmin(){ return !!getToken(); }
function setAdminToken(token){
  if(token) sessionStorage.setItem(TOKEN_KEY, token);
  else sessionStorage.removeItem(TOKEN_KEY);
  document.body.classList.toggle("isAdmin", !!token);
  syncLoginUI();
  render();
}
function syncLoginUI(){
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const loginText = document.getElementById("loginText");
  btnLogin.style.display = isAdmin() ? "none" : "inline-flex";
  btnLogout.style.display = isAdmin() ? "inline-flex" : "none";
  loginText.textContent = isAdmin() ? "ç®¡ç†å‘˜å·²ç™»å½•" : "æ¸¸å®¢æ¨¡å¼";
}

function syncSidebarState(){
  document.body.classList.toggle("sidebarCollapsed", isSidebarCollapsed);
}

/** URL æ˜¾ç¤ºçŸ­é“¾æ¥ï¼ˆä¸æ’‘é«˜åº¦ï¼‰ */
function shortUrl(url){
  try{
    const u = new URL(url);
    return u.host + "/â€¦";
  }catch{
    return url || "";
  }
}

/** favicon / icon */
function getDomainFromUrl(u){ try { return new URL(u).hostname; } catch { return ""; } }
function autoFaviconUrl(siteUrl, size=64){
  const domain = getDomainFromUrl(siteUrl);
  if(!domain) return "";
  return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=${size}`;
}
function placeholderIconDataUrl(){
  return "data:image/svg+xml;base64," + btoa(
    `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
      <rect width='64' height='64' rx='18' fill='rgba(16,24,40,.05)'/>
      <path d='M22 32h20' stroke='rgba(16,24,40,.35)' stroke-width='4' stroke-linecap='round'/>
    </svg>`
  );
}
function resolveIconSrc(site){
  const manual = (site.icon || "").trim();
  if(manual) return manual;
  const auto = autoFaviconUrl(site.url, 64);
  return auto || placeholderIconDataUrl();
}

function getCategoryIcon(cat){
  const raw = (cat.icon || "").trim();
  return raw || "ğŸ“";
}
function createCategoryIconNode(cat){
  const icon = getCategoryIcon(cat);
  const wrap = document.createElement("div");
  wrap.className = "catIcon";
  if(/^https?:\/\//.test(icon) || icon.startsWith("data:")){
    const img = document.createElement("img");
    img.src = icon;
    img.alt = "icon";
    img.onerror = ()=>{ img.onerror=null; wrap.textContent="ğŸ“"; };
    wrap.appendChild(img);
  }else{
    wrap.textContent = icon;
  }
  return wrap;
}

function subcatAnchorId(id){ return `subcat-${id}`; }
function scrollToSubcat(id){
  const panel = document.querySelector(".panel");
  const el = document.getElementById(subcatAnchorId(id));
  if(!panel || !el) return;
  const top = Math.max(0, el.offsetTop - 8);
  panel.scrollTo({ top, behavior:"smooth" });
}
function getActiveSubcatId(){ return activeSubcatId; }

/** ==========================
 *  Tooltip Preview
 * ========================== */
const TT = { el:null, t:null, u:null, d:null, visible:false };
function initTooltip(){
  TT.el = document.getElementById("tooltip");
  TT.t  = document.getElementById("ttTitle");
  TT.u  = document.getElementById("ttUrl");
  TT.d  = document.getElementById("ttDesc");
}
function showTooltip(payload){
  if(!TT.el) initTooltip();
  TT.t.textContent = payload.title || "";
  TT.u.textContent = payload.url || "";
  TT.d.textContent = payload.desc || "";
  TT.el.style.display = "block";
  TT.visible = true;
}
function hideTooltip(){
  if(!TT.el) return;
  TT.el.style.display="none";
  TT.visible=false;
}
function moveTooltip(clientX, clientY){
  if(!TT.el || !TT.visible) return;
  const margin=14, offset=16;
  let x=clientX+offset, y=clientY+offset;
  const rect = TT.el.getBoundingClientRect();
  if(x+rect.width+margin>window.innerWidth) x=clientX-rect.width-offset;
  if(y+rect.height+margin>window.innerHeight) y=clientY-rect.height-offset;
  x=Math.max(margin, Math.min(x, window.innerWidth-rect.width-margin));
  y=Math.max(margin, Math.min(y, window.innerHeight-rect.height-margin));
  TT.el.style.left=x+"px";
  TT.el.style.top=y+"px";
}

/** ==========================
 *  Modal
 * ========================== */
const modalMask = document.getElementById("modalMask");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalFoot = document.getElementById("modalFoot");
document.getElementById("modalClose").onclick = closeModal;
modalMask.addEventListener("click", (e)=>{ if(e.target===modalMask) closeModal(); });

function openModal(title, bodyNodes, footNodes){
  modalTitle.textContent = title;
  modalBody.innerHTML="";
  modalFoot.innerHTML="";
  bodyNodes.forEach(n=>modalBody.appendChild(n));
  footNodes.forEach(n=>modalFoot.appendChild(n));
  modalMask.style.display="flex";
}
function closeModal(){ modalMask.style.display="none"; }

function button(text, cls, onClick){
  const b=document.createElement("button");
  b.className=cls;
  b.textContent=text;
  b.onclick=onClick;
  return b;
}
function input(labelText, value="", type="text"){
  const wrap=document.createElement("div");
  const lab=document.createElement("div");
  lab.textContent=labelText;
  lab.style.fontSize="12px";
  lab.style.color="var(--muted)";
  lab.style.marginBottom="6px";
  const el=document.createElement("input");
  el.type=type;
  el.value=value??"";
  el.style.width="100%";
  el.style.padding="10px";
  el.style.border="1px solid var(--line)";
  el.style.borderRadius="12px";
  el.autocomplete="off";
  wrap.append(lab, el);
  return {wrap, el};
}
function textarea(labelText, value=""){
  const wrap=document.createElement("div");
  const lab=document.createElement("div");
  lab.textContent=labelText;
  lab.style.fontSize="12px";
  lab.style.color="var(--muted)";
  lab.style.marginBottom="6px";
  const el=document.createElement("textarea");
  el.value=value??"";
  el.style.width="100%";
  el.style.padding="10px";
  el.style.border="1px solid var(--line)";
  el.style.borderRadius="12px";
  el.style.minHeight="90px";
  wrap.append(lab, el);
  return {wrap, el};
}
function row2(a,b){
  const r=document.createElement("div");
  r.style.display="flex";
  r.style.gap="10px";
  r.append(a,b);
  a.style.flex="1"; b.style.flex="1";
  return r;
}

/** ==========================
 *  API Calls
 * ========================== */
async function apiGetData(){
  const res = await fetch(API_DATA_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("GET /api/data failed");
  const obj = await res.json();
  obj.categories ||= [];
  obj.categories.forEach(c=>{
    if(typeof c.icon !== "string") c.icon = "";
    c.subcategories ||= [];
    c.subcategories.forEach(s=>{
      s.sites ||= [];
      s.sites.forEach(site=>{ if(typeof site.icon !== "string") site.icon=""; });
    });
  });
  return obj;
}
async function apiLogin(username, password){
  const res = await fetch(API_LOGIN_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, password })
  });
  if(!res.ok) throw new Error("login failed");
  return await res.json();
}
async function apiLogout(){
  const token=getToken();
  if(!token) return;
  try{
    await fetch(API_LOGOUT_URL, { method:"POST", headers:{ "Authorization":"Bearer "+token } });
  }catch{}
}
async function apiSaveData(){
  if(!isAdmin()) return;
  const token=getToken();
  const res = await fetch(API_DATA_URL, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body: JSON.stringify(state)
  });
  if(!res.ok){
    if(res.status===401){
      toast("ä¿å­˜å¤±è´¥ï¼šç™»å½•å·²è¿‡æœŸ");
      setAdminToken("");
      return;
    }
    toast("ä¿å­˜å¤±è´¥ï¼š"+res.status);
    return;
  }
  const out = await res.json();
  if(out?.updatedAt) state.updatedAt = out.updatedAt;
}

function saveLocalCache(){ try{ localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(state)); }catch{} }
function loadLocalCache(){ try{ const raw=localStorage.getItem(LOCAL_CACHE_KEY); return raw?JSON.parse(raw):null; }catch{return null;} }
async function saveAll(){
  saveLocalCache();
  await apiSaveData();
}

function requireAdmin(){
  if(!isAdmin()){
    toast("éœ€è¦ç®¡ç†å‘˜ç™»å½•");
    openLoginModal();
    return false;
  }
  return true;
}

/** ==========================
 *  Render
 * ========================== */
function getActiveCat(){
  return state.categories.find(c=>c.id===activeCatId) || state.categories[0] || null;
}

function render(){
  renderSidebar();
  renderContent();
}

function renderSidebar(){
  const list=document.getElementById("catList");
  list.innerHTML="";
  const cats=[...(state.categories||[])].sort(byOrder);
  if(!activeCatId && cats[0]) activeCatId=cats[0].id;
  if(activeCatId && expandedCatIds.size===0) expandedCatIds.add(activeCatId);

  cats.forEach(cat=>{
    const group=document.createElement("div");
    group.className="catGroup"+(expandedCatIds.has(cat.id)?" expanded":"");

    const item=document.createElement("div");
    item.className="catItem"+(cat.id===activeCatId?" active":"");

    const left=document.createElement("div");
    left.style.display="flex";
    left.style.alignItems="center";
    left.style.gap="8px";

    const toggle=document.createElement("button");
    toggle.className="catToggle";
    toggle.setAttribute("aria-label", "å±•å¼€/æ”¶èµ·");
    toggle.onclick=(e)=>{
      e.stopPropagation();
      if(expandedCatIds.has(cat.id)) expandedCatIds.delete(cat.id);
      else expandedCatIds.add(cat.id);
      renderSidebar();
    };

    const toggleIcon=document.createElement("span");
    toggleIcon.className="catToggleIcon";
    toggleIcon.textContent="â–¶";

    toggle.appendChild(toggleIcon);

    const name=document.createElement("div");
    name.textContent=cat.name;

    const catIcon = createCategoryIconNode(cat);

    left.append(toggle, catIcon, name);

    const right=document.createElement("div");
    right.style.display="flex";
    right.style.gap="6px";

    const edit=document.createElement("button");
    edit.className="btn adminOnly";
    edit.textContent="âœ";
    edit.style.padding="6px 10px";
    edit.onclick=(e)=>{ e.stopPropagation(); openCategoryModal(cat); };

    const del=document.createElement("button");
    del.className="btn danger adminOnly";
    del.textContent="ğŸ—‘";
    del.style.padding="6px 10px";
    del.onclick=async(e)=>{
      e.stopPropagation();
      if(!requireAdmin()) return;
      if(confirm(`ç¡®å®šåˆ é™¤ã€Œ${cat.name}ã€ï¼Ÿ`)){
        state.categories = state.categories.filter(c=>c.id!==cat.id);
        expandedCatIds.delete(cat.id);
        if(activeCatId===cat.id) activeCatId = state.categories[0]?.id || null;
        await saveAll();
        render();
      }
    };

    item.onclick=()=>{
      activeCatId=cat.id;
      activeSubcatId=null;
      expandedCatIds.add(cat.id);
      render();
    };

    right.append(edit, del);
    item.append(left, right);

    const subList=document.createElement("div");
    subList.className="subList";
    const subcats=(cat.subcategories||[]).slice().sort(byOrder);
    if(!subcats.length){
      const empty=document.createElement("div");
      empty.style.fontSize="12px";
      empty.style.color="var(--muted)";
      empty.style.padding="4px 10px";
      empty.textContent="æš‚æ— äºŒçº§åˆ†ç±»";
      subList.appendChild(empty);
    }else{
      subcats.forEach(subcat=>{
        const subItem=document.createElement("div");
        subItem.className="subItem";
        if(cat.id===activeCatId && subcat.id===getActiveSubcatId()) subItem.classList.add("active");

        const subName=document.createElement("div");
        subName.textContent=subcat.name;

        const subMeta=document.createElement("div");
        subMeta.style.fontSize="12px";
        subMeta.style.color="var(--muted)";
        subMeta.textContent=String(subcat.sites?.length||0);

        subItem.append(subName, subMeta);
        subItem.onclick=()=>{
          activeCatId=cat.id;
          activeSubcatId=subcat.id;
          expandedCatIds.add(cat.id);
          render();
          requestAnimationFrame(()=>scrollToSubcat(subcat.id));
        };
        subList.appendChild(subItem);
      });
    }

    group.append(item, subList);
    list.appendChild(group);
  });
}

function renderContent(){
  const cat=getActiveCat();
  const content=document.getElementById("content");
  const title=document.getElementById("activeTitle");
  const meta=document.getElementById("activeMeta");

  if(!cat){
    title.textContent="æ²¡æœ‰åˆ†ç±»";
    meta.textContent="è¯·ç®¡ç†å‘˜ç™»å½•åæ–°å¢";
    content.innerHTML="<div style='padding:20px;color:var(--muted)'>æš‚æ— æ•°æ®</div>";
    return;
  }

  title.textContent=cat.name;
  meta.textContent=`äºŒçº§åˆ†ç±»ï¼š${cat.subcategories?.length||0} Â· æœ€è¿‘æ›´æ–°ï¼š${fmtTime(state.updatedAt)}`;

  const subcats=(cat.subcategories||[]).slice().sort(byOrder);
  if(activeSubcatId && !subcats.some(sc=>sc.id===activeSubcatId)) activeSubcatId=null;

  // æœç´¢ï¼ˆå…¨å±€ï¼‰
  if(searchText.trim()){
    const q=searchText.trim().toLowerCase();
    const matched=[];
    const cats=[...(state.categories||[])].sort(byOrder);
    cats.forEach(c=>{
      const scs=(c.subcategories||[]).slice().sort(byOrder);
      scs.forEach(sc=>{
        const sites=(sc.sites||[]).filter(s=>{
          return (s.title||"").toLowerCase().includes(q)
            || (s.desc||"").toLowerCase().includes(q)
            || (s.url||"").toLowerCase().includes(q);
        }).sort(byOrder);
        if(sites.length) matched.push({cat:c, sc, sites});
      });
    });

    title.textContent="æœç´¢ç»“æœ";
    meta.textContent=`åŒ¹é… ${matched.length} ä¸ªäºŒçº§åˆ†ç±»`;

    if(!matched.length){
      content.innerHTML="<div style='padding:20px;color:var(--muted)'>æ²¡æœ‰æœç´¢ç»“æœ</div>";
      return;
    }
    const wrap=document.createElement("div");
    wrap.className="subcats";
    matched.forEach(({cat:matchCat, sc, sites})=>{
      wrap.appendChild(renderSubcatBlock(matchCat, sc, sites, true));
    });
    content.innerHTML="";
    content.appendChild(wrap);
    return;
  }

  if(!subcats.length){
    content.innerHTML="<div style='padding:20px;color:var(--muted)'>æš‚æ— äºŒçº§åˆ†ç±»</div>";
    return;
  }

  const wrap=document.createElement("div");
  wrap.className="subcats";
  subcats.forEach(sc=>{
    const sites=(sc.sites||[]).slice().sort(byOrder);
    wrap.appendChild(renderSubcatBlock(cat, sc, sites, false));
  });

  content.innerHTML="";
  content.appendChild(wrap);
}

function renderSubcatBlock(cat, subcat, sites, searchMode){
  const box=document.createElement("div");
  box.className="subcat";
  box.id = subcatAnchorId(subcat.id);

  const head=document.createElement("div");
  head.className="subHead";

  const left=document.createElement("div");
  left.innerHTML=`<b>${subcat.name}</b> <span style="color:var(--muted);font-size:12px">ï¼ˆç½‘ç«™ ${sites.length}ï¼‰</span>`;

  const right=document.createElement("div");
  right.style.display="flex";
  right.style.gap="8px";
  right.style.flexWrap="wrap";

  if(!searchMode){
    const add=button("æ–°å¢ç½‘ç«™","btn ok adminOnly",()=>{ if(requireAdmin()) openSiteModal(cat, subcat, null); });
    right.appendChild(add);
  }
  right.appendChild(button("ç¼–è¾‘äºŒçº§","btn adminOnly",()=>{ if(requireAdmin()) openSubcategoryModal(cat, subcat); }));
  right.appendChild(button("åˆ é™¤äºŒçº§","btn danger adminOnly",async()=>{
    if(!requireAdmin()) return;
    if(confirm(`ç¡®å®šåˆ é™¤äºŒçº§ã€Œ${subcat.name}ã€ï¼Ÿ`)){
      cat.subcategories = cat.subcategories.filter(s=>s.id!==subcat.id);
      await saveAll();
      render();
    }
  }));

  head.append(left,right);

  const cards=document.createElement("div");
  cards.className="cards";

  if(!sites.length){
    const empty=document.createElement("div");
    empty.style.gridColumn="1/-1";
    empty.style.padding="18px";
    empty.style.color="var(--muted)";
    empty.textContent=isAdmin() ? "æš‚æ— ç½‘ç«™ï¼Œç‚¹å‡»æ–°å¢æ·»åŠ ã€‚" : "æš‚æ— ç½‘ç«™ï¼ˆç®¡ç†å‘˜ç™»å½•åå¯æ·»åŠ ï¼‰ã€‚";
    cards.appendChild(empty);
  }else{
    sites.forEach(site=>cards.appendChild(renderSiteCard(cat, subcat, site)));
  }

  box.append(head, cards);
  return box;
}

function renderSiteCard(cat, subcat, site){
  const card=document.createElement("div");
  card.className="card";

  // Tooltip hover
  card.addEventListener("mouseenter",(e)=>{
    if(window.matchMedia && window.matchMedia("(hover: none)").matches) return;
    showTooltip({ title: site.title||"", url: site.url||"", desc: site.desc||"" });
    moveTooltip(e.clientX, e.clientY);
  });
  card.addEventListener("mousemove",(e)=>moveTooltip(e.clientX, e.clientY));
  card.addEventListener("mouseleave",()=>hideTooltip());

  const top=document.createElement("div");
  top.style.display="flex";
  top.style.justifyContent="space-between";
  top.style.gap="10px";

  const left=document.createElement("div");
  left.style.display="flex";
  left.style.gap="10px";
  left.style.minWidth="0";

  const icon=document.createElement("img");
  icon.src=resolveIconSrc(site);
  icon.onerror=()=>{ icon.onerror=null; icon.src=placeholderIconDataUrl(); };
  icon.style.width="34px";
  icon.style.height="34px";
  icon.style.borderRadius="12px";
  icon.style.border="1px solid rgba(16,24,40,.12)";
  icon.style.flex="0 0 auto";

  const info=document.createElement("div");
  info.style.minWidth="0";

  const t=document.createElement("div");
  t.className="cardTitle";
  t.textContent=site.title||"(æœªå‘½å)";
  t.title = site.title || "";

  const u=document.createElement("a");
  u.className="cardUrl";
  u.href=site.url||"#";
  u.target="_blank";
  u.rel="noopener noreferrer";
  u.textContent=shortUrl(site.url);
  u.title=site.url||"";

  info.append(t,u);
  left.append(icon,info);

  const acts=document.createElement("div");
  acts.style.display="flex";
  acts.style.gap="6px";

  const go=button("â†—","btn",()=>site.url?window.open(site.url,"_blank","noopener,noreferrer"):toast("æ— URL"));
  go.style.padding="6px 10px";

  const edit=button("âœ","btn adminOnly",()=>{ if(requireAdmin()) openSiteModal(cat, subcat, site); });
  edit.style.padding="6px 10px";

  const del=button("ğŸ—‘","btn danger adminOnly",async()=>{
    if(!requireAdmin()) return;
    if(confirm(`ç¡®å®šåˆ é™¤ã€Œ${site.title}ã€ï¼Ÿ`)){
      subcat.sites = (subcat.sites||[]).filter(s=>s.id!==site.id);
      await saveAll();
      render();
    }
  });
  del.style.padding="6px 10px";

  acts.append(go, edit, del);

  top.append(left, acts);

  const desc=document.createElement("div");
  desc.className="cardDesc";
  desc.textContent=site.desc||"";

  card.append(top, desc);
  return card;
}
</script>
<script>
/** ==========================
 *  ç™»å½•å¼¹çª—
 * ========================== */
function openLoginModal(){
  const u = input("è´¦å·", "");
  const p = input("å¯†ç ", "", "password");
  u.el.autocomplete = "username";
  p.el.autocomplete = "current-password";

  const hint = document.createElement("div");
  hint.style.fontSize="12px";
  hint.style.color="var(--muted)";
  hint.textContent="ç™»å½•æˆåŠŸåå¯ç¼–è¾‘/ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¤šè®¾å¤‡åŒæ­¥ï¼‰";

  const btnCancel = button("å–æ¶ˆ","btn",closeModal);
  const btnOk = button("ç™»å½•","btn primary", async ()=>{
    const user = u.el.value.trim();
    const pass = p.el.value;
    if(!user || !pass) return toast("è¯·è¾“å…¥è´¦å·å¯†ç ");
    try{
      const out = await apiLogin(user, pass);
      setAdminToken(out.token);
      closeModal();
      toast("ç™»å½•æˆåŠŸ");
    }catch{
      toast("è´¦å·æˆ–å¯†ç é”™è¯¯");
    }
  });

  openModal("ç®¡ç†å‘˜ç™»å½•",[u.wrap,p.wrap,hint],[btnCancel,btnOk]);
}

/** ==========================
 *  CRUDï¼šä¸€çº§åˆ†ç±»
 * ========================== */
function openCategoryModal(cat){
  if(!requireAdmin()) return;
  const isNew = !cat;
  const data = cat ? {...cat} : { id: uid(), name:"", icon:"ğŸ“", order: nextOrder(state.categories), subcategories: [] };

  const name = input("åç§°", data.name);
  const icon = input("å›¾æ ‡ï¼ˆemoji æˆ–å›¾ç‰‡URLï¼‰", data.icon || "ğŸ“");
  const order = input("æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰", data.order, "number");

  const btnCancel = button("å–æ¶ˆ","btn",closeModal);
  const btnSave = button(isNew?"åˆ›å»º":"ä¿å­˜","btn primary", async ()=>{
    const vName=name.el.value.trim();
    const vIcon=icon.el.value.trim();
    const vOrder=parseInt(order.el.value,10);
    if(!vName) return toast("è¯·è¾“å…¥åç§°");
    data.name=vName;
    data.icon=vIcon || "ğŸ“";
    data.order=Number.isFinite(vOrder)?vOrder:999;

    if(isNew){
      state.categories.push(data);
      activeCatId=data.id;
    }else{
      const idx=state.categories.findIndex(c=>c.id===data.id);
      if(idx>=0){
        data.subcategories = state.categories[idx].subcategories || [];
        state.categories[idx]=data;
      }
    }

    await saveAll();
    render();
    closeModal();
    toast("å·²ä¿å­˜");
  });

  openModal(isNew?"æ–°å¢ä¸€çº§åˆ†ç±»":"ç¼–è¾‘ä¸€çº§åˆ†ç±»",[row2(name.wrap, order.wrap), icon.wrap],[btnCancel,btnSave]);
}

/** ==========================
 *  CRUDï¼šäºŒçº§åˆ†ç±»
 * ========================== */
function openSubcategoryModal(cat, subcat){
  if(!requireAdmin()) return;
  const isNew = !subcat;
  const data = subcat ? {...subcat} : { id: uid(), name:"", order: nextOrder(cat.subcategories||[]), sites: [] };

  const name = input("åç§°", data.name);
  const order = input("æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰", data.order, "number");

  const btnCancel = button("å–æ¶ˆ","btn",closeModal);
  const btnSave = button(isNew?"åˆ›å»º":"ä¿å­˜","btn primary", async ()=>{
    const vName=name.el.value.trim();
    const vOrder=parseInt(order.el.value,10);
    if(!vName) return toast("è¯·è¾“å…¥åç§°");
    data.name=vName;
    data.order=Number.isFinite(vOrder)?vOrder:999;

    cat.subcategories ||= [];
    if(isNew){
      cat.subcategories.push(data);
    }else{
      const idx=cat.subcategories.findIndex(s=>s.id===data.id);
      if(idx>=0){
        data.sites = cat.subcategories[idx].sites || [];
        cat.subcategories[idx]=data;
      }
    }

    await saveAll();
    render();
    closeModal();
    toast("å·²ä¿å­˜");
  });

  openModal(isNew?"æ–°å¢äºŒçº§åˆ†ç±»":"ç¼–è¾‘äºŒçº§åˆ†ç±»",[row2(name.wrap, order.wrap)],[btnCancel,btnSave]);
}

/** ==========================
 *  CRUDï¼šç½‘ç«™ï¼ˆå« icon ä¸Šä¼ è½¬ base64ï¼‰
 * ========================== */
function openSiteModal(cat, subcat, site){
  if(!requireAdmin()) return;

  const isNew=!site;
  const data = site ? {...site} : { id: uid(), title:"", url:"", desc:"", icon:"", order: nextOrder(subcat.sites||[]) };

  const title = input("æ ‡é¢˜", data.title);
  const url = input("URL", data.url, "url");
  const order = input("æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰", data.order, "number");
  const icon = input("Iconï¼ˆå¯é€‰ï¼šç²˜è´´å›¾ç‰‡URLæˆ–base64ï¼›ä¸ºç©ºåˆ™è‡ªåŠ¨faviconï¼‰", data.icon||"");
  const desc = textarea("æè¿°", data.desc||"");

  // ä¸Šä¼ è½¬ base64
  const uploadBox = document.createElement("div");
  uploadBox.style.border="1px dashed rgba(16,24,40,.2)";
  uploadBox.style.borderRadius="14px";
  uploadBox.style.padding="10px";
  uploadBox.style.background="#f9fafb";

  const upLab = document.createElement("div");
  upLab.style.fontSize="12px";
  upLab.style.color="var(--muted)";
  upLab.style.marginBottom="6px";
  upLab.textContent="ä¸Šä¼ Iconï¼ˆè½¬ base64 å†™å…¥ Icon å­—æ®µï¼‰";

  const file = document.createElement("input");
  file.type="file";
  file.accept="image/*";

  const help = document.createElement("div");
  help.style.fontSize="12px";
  help.style.color="var(--muted)";
  help.style.marginTop="6px";
  help.innerHTML = "å»ºè®®å°å›¾ï¼ˆ64/128ï¼‰ï¼Œè¿‡å¤§çš„ base64 ä¼šå½±å“åŠ è½½ã€‚";

  const preview = document.createElement("div");
  preview.style.display="flex";
  preview.style.gap="10px";
  preview.style.alignItems="center";
  preview.style.marginTop="10px";

  const img = document.createElement("img");
  img.style.width="44px";
  img.style.height="44px";
  img.style.borderRadius="14px";
  img.style.border="1px solid rgba(16,24,40,.12)";

  const clearBtn = button("æ¸…ç©ºæ‰‹åŠ¨Iconï¼ˆæ”¹ç”¨è‡ªåŠ¨faviconï¼‰","btn",()=>{
    icon.el.value="";
    refreshPreview();
    toast("å·²æ¸…ç©º");
  });
  clearBtn.style.padding="6px 10px";

  preview.append(img, clearBtn);

  function refreshPreview(){
    const manual = icon.el.value.trim();
    if(manual){
      img.src = manual;
      img.onerror=()=>{ img.onerror=null; img.src=placeholderIconDataUrl(); };
      return;
    }
    img.src = autoFaviconUrl(url.el.value.trim(), 64) || placeholderIconDataUrl();
    img.onerror=()=>{ img.onerror=null; img.src=placeholderIconDataUrl(); };
  }

  icon.el.addEventListener("input", refreshPreview);
  url.el.addEventListener("input", refreshPreview);

  file.onchange=()=>{
    const f=file.files?.[0];
    if(!f) return;
    if(f.size > 300*1024){
      if(!confirm("å›¾ç‰‡è¾ƒå¤§ï¼Œè½¬base64ä¼šå ç©ºé—´ä¸”æ…¢ï¼Œä»ç»§ç»­ï¼Ÿ")) return;
    }
    const reader=new FileReader();
    reader.onload=()=>{
      icon.el.value=String(reader.result||"");
      refreshPreview();
      toast("å·²è½¬base64");
    };
    reader.readAsDataURL(f);
  };

  uploadBox.append(upLab, file, help, preview);
  refreshPreview();

  const btnCancel = button("å–æ¶ˆ","btn",closeModal);
  const btnSave = button(isNew?"åˆ›å»º":"ä¿å­˜","btn primary", async ()=>{
    const vTitle=title.el.value.trim();
    const vUrl=url.el.value.trim();
    const vOrder=parseInt(order.el.value,10);
    if(!vTitle) return toast("è¯·è¾“å…¥æ ‡é¢˜");
    if(!vUrl) return toast("è¯·è¾“å…¥URL");

    data.title=vTitle;
    data.url=vUrl;
    data.order=Number.isFinite(vOrder)?vOrder:999;
    data.icon=icon.el.value.trim();
    data.desc=desc.el.value.trim();

    subcat.sites ||= [];
    if(isNew){
      subcat.sites.push(data);
    }else{
      const idx=subcat.sites.findIndex(s=>s.id===data.id);
      if(idx>=0) subcat.sites[idx]=data;
    }

    await saveAll();
    render();
    closeModal();
    toast("å·²ä¿å­˜");
  });

  openModal(isNew?"æ–°å¢ç½‘ç«™":"ç¼–è¾‘ç½‘ç«™",
    [
      row2(title.wrap, order.wrap),
      url.wrap,
      icon.wrap,
      uploadBox,
      desc.wrap
    ],
    [btnCancel, btnSave]
  );
}

/** ==========================
 *  å¯¼å…¥/å¯¼å‡º
 * ========================== */
document.getElementById("btnExport").onclick=()=>{
  if(!requireAdmin()) return;
  const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`nav_export_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("å·²å¯¼å‡º");
};

document.getElementById("btnImport").onclick=()=>{
  if(!requireAdmin()) return;
  const inp=document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange=async()=>{
    const f=inp.files?.[0];
    if(!f) return;
    try{
      const txt=await f.text();
      const obj=JSON.parse(txt);
      if(!obj || !Array.isArray(obj.categories)) throw new Error("æ ¼å¼é”™è¯¯ï¼šéœ€è¦ categories æ•°ç»„");

      obj.categories.forEach(c=>{
        if(typeof c.icon !== "string") c.icon = "";
        c.subcategories ||= [];
        c.subcategories.forEach(s=>{
          s.sites ||= [];
          s.sites.forEach(site=>{ if(typeof site.icon !== "string") site.icon=""; });
        });
      });

      state=obj;
      activeCatId=state.categories[0]?.id || null;
      await saveAll();
      render();
      toast("å·²å¯¼å…¥å¹¶åŒæ­¥");
    }catch(e){
      alert("å¯¼å…¥å¤±è´¥ï¼š"+(e?.message||e));
    }
  };
  inp.click();
};

/** ==========================
 *  é¡¶éƒ¨æŒ‰é’®ç»‘å®š
 * ========================== */
document.getElementById("btnLogin").onclick=()=>openLoginModal();
document.getElementById("btnLogout").onclick=async()=>{ await apiLogout(); setAdminToken(""); toast("å·²é€€å‡º"); };

document.getElementById("btnAddTop").onclick=()=>openCategoryModal(null);

document.getElementById("btnAddSub").onclick=()=>{
  if(!requireAdmin()) return;
  const cat=getActiveCat();
  if(!cat) return toast("è¯·å…ˆåˆ›å»ºä¸€çº§åˆ†ç±»");
  openSubcategoryModal(cat,null);
};

document.getElementById("btnAddSite").onclick=()=>{
  if(!requireAdmin()) return;
  const cat=getActiveCat();
  if(!cat) return toast("è¯·å…ˆåˆ›å»ºä¸€çº§åˆ†ç±»");
  const subs=(cat.subcategories||[]).slice().sort(byOrder);
  if(!subs.length) return toast("è¯·å…ˆåˆ›å»ºäºŒçº§åˆ†ç±»");
  openSiteModal(cat, subs[0], null);
};

document.getElementById("searchInput").addEventListener("input",(e)=>{
  searchText = e.target.value || "";
  renderContent();
});
document.getElementById("btnToggleSidebar").addEventListener("click", ()=>{
  isSidebarCollapsed = !isSidebarCollapsed;
  syncSidebarState();
});

/** ==========================
 *  Bootï¼šä»æ•°æ®åº“åŠ è½½
 * ========================== */
(async function boot(){
  document.body.classList.toggle("isAdmin", isAdmin());
  syncLoginUI();
  syncSidebarState();

  try{
    state = await apiGetData();
    saveLocalCache();
  }catch{
    const local = loadLocalCache();
    if(local && Array.isArray(local.categories)){
      state = local;
      toast("APIè¯»å–å¤±è´¥ï¼šå›é€€æœ¬åœ°ç¼“å­˜");
    }else{
      toast("APIè¯»å–å¤±è´¥ï¼šæš‚æ— æ•°æ®");
    }
  }

  activeCatId = state.categories?.[0]?.id || null;
  render();
})();
</script>
</body>
</html>
